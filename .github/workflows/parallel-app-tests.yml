name: Parallel Sample App Tests

on:
  push:
    branches:
      - main
      - add-reusable-actions
    paths:
      - '.github/workflows/parallel-app-tests.yml'
      - '.github/actions/deploy-sample-app/**'
      - 'sample-resources/**'
      - 'Makefile'
  workflow_dispatch:  # Manual trigger
    inputs:
      apps:
        description: 'Apps to test (comma-separated, or "all")'
        required: false
        default: 'all'

jobs:
  # Setup job to generate dynamic matrix
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate matrix based on input
        id: set-matrix
        run: |
          # For push events, always test all apps
          # For workflow_dispatch, use the input or default to all
          APPS_INPUT="${{ github.event.inputs.apps }}"
          
          if [ "${{ github.event_name }}" == "push" ] || [ "$APPS_INPUT" == "all" ] || [ -z "$APPS_INPUT" ]; then
            # Test all apps
            echo 'matrix=["hello-world","wordpress"]' >> $GITHUB_OUTPUT
            echo "Testing all apps: hello-world, wordpress"
          else
            # Convert comma-separated input to JSON array
            # Remove spaces and convert to JSON array format
            JSON_ARRAY=$(echo "$APPS_INPUT" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R -s -c 'split("\n")[:-1]')
            echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT
            echo "Testing apps: $APPS_INPUT"
          fi

  # Matrix strategy to test apps in parallel
  test-apps:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false  # Continue testing other apps even if one fails
      matrix:
        app: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1

      - name: Verify cluster status
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy and validate ${{ matrix.app }}
        uses: ./.github/actions/deploy-sample-app
        with:
          app-name: ${{ matrix.app }}
          verify-health: 'true'
          timeout: '300'

      - name: Cleanup
        if: always()
        run: make resources-destroy ${{ matrix.app }} || true

  # Summary job that depends on all matrix jobs
  summary:
    runs-on: ubuntu-latest
    needs: test-apps
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-apps.result }}" == "success" ]; then
            echo "✅ All app tests passed!"
            exit 0
          else
            echo "❌ Some app tests failed"
            exit 1
          fi
